<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Verify OTP - Password Reset</title>
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        body {
            background: linear-gradient(135deg, #001a33 0%, #003366 100%);
            min-height: 100vh;
        }

        .otp-input {
            width: 50px;
            height: 50px;
            text-align: center;
            font-size: 24px;
            font-weight: bold;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            background: white;
            color: #001a33;
            transition: all 0.3s ease;
        }

        .otp-input:focus {
            outline: none;
            border-color: #2563eb;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .resend-link {
            color: #60a5fa;
            cursor: pointer;
            text-decoration: none;
        }

        .resend-link:hover {
            color: #93c5fd;
            text-decoration: underline;
        }

        .resend-link.disabled {
            color: #9ca3af;
            cursor: not-allowed;
        }
    </style>
</head>

<body>
<div class="flex items-center justify-center min-h-screen px-4">
    <div class="w-full max-w-md">

        <form id="otpForm" action="/vendor/auth/forgot-password/verify-otp" method="POST" class="space-y-8">

            <!-- Header -->
            <div class="text-center">
                <h1 class="text-3xl font-bold text-white mb-4">Verify OTP</h1>
                <p class="text-gray-400 text-sm">
                    We've sent a verification code to<br>
                    <span class="text-white font-semibold"><%= email %></span>
                </p>
            </div>

            <!-- OTP Inputs -->
            <div class="flex justify-center gap-3">
                <% for (let i = 0; i < 4; i++) { %>
                    <input
                        type="text"
                        class="otp-input"
                        maxlength="1"
                        inputmode="numeric"
                        id="otp-<%= i %>"
                        required
                    >
                <% } %>
            </div>

            <!-- Hidden OTP -->
            <input type="hidden" name="otp" id="otp">

            <!-- Error Message -->
            <% if (error) { %>
                <div
                    id="errorBox"
                    class="bg-red-500 bg-opacity-10 border border-red-500 text-red-200 px-4 py-3 rounded-lg text-sm text-center">
                    <%= error %>
                </div>
            <% } %>

            <!-- Timer -->
            <div class="text-center">
                <p id="timerText" class="text-gray-300 text-sm">
                    Resend code in <span id="timer">05:00</span>
                </p>
            </div>

            <!-- Resend -->
            <div class="text-center">
                <button
                    type="button"
                    id="resendBtn"
                    class="resend-link disabled"
                    onclick="resendCode()"
                    disabled>
                    Resend OTP
                </button>
            </div>

            <!-- Submit -->
            <button
                type="submit"
                class="w-full bg-white text-slate-900 font-semibold py-3 rounded-lg hover:bg-gray-100 transition">
                Verify & Continue
            </button>

        </form>

        <div class="text-center mt-6">
            <a href="/vendor/auth/forgot-password" class="text-blue-400 hover:text-blue-300 text-sm">
                Back to Forgot Password
            </a>
        </div>

    </div>
</div>

<script>
/* ================= OTP INPUT HANDLING ================= */
const inputs = document.querySelectorAll(".otp-input");
const hiddenOtpField = document.getElementById("otp");

inputs.forEach((input, index) => {
    input.addEventListener("input", () => {
        if (!/^[0-9]$/.test(input.value)) {
            input.value = "";
            return;
        }
        if (index < inputs.length - 1) {
            inputs[index + 1].focus();
        }
    });

    input.addEventListener("keydown", (e) => {
        if (e.key === "Backspace" && input.value === "" && index > 0) {
            inputs[index - 1].focus();
        }
    });
});

/* ================= FORM SUBMIT ================= */
document.getElementById("otpForm").addEventListener("submit", function (e) {
    const otp = Array.from(inputs).map(i => i.value).join("");

    if (otp.length !== 4) {
        e.preventDefault();
        alert("Please enter a valid 4-digit OTP");
        return;
    }
    hiddenOtpField.value = otp;
});

/* ================= TIMER (FIXED VARIABLE NAME) ================= */
let otpTimeRemaining =  timeRemaining || 300 ;
const timerEl = document.getElementById("timer");
const resendBtn = document.getElementById("resendBtn");

function updateTimer() {
    const minutes = Math.floor(otpTimeRemaining / 60);
    const seconds = otpTimeRemaining % 60;

    timerEl.textContent =
        `${String(minutes).padStart(2, "0")}:${String(seconds).padStart(2, "0")}`;

    if (otpTimeRemaining > 0) {
        otpTimeRemaining--;
        setTimeout(updateTimer, 1000);
    } else {
        resendBtn.disabled = false;
        resendBtn.classList.remove("disabled");
        document.getElementById("timerText").textContent = "Code expired. Resend now";
    }
}

updateTimer();

/* ================= RESEND OTP ================= */
function resendCode() {
    if (resendBtn.disabled) return;

    resendBtn.disabled = true;
    resendBtn.classList.add("disabled");

    otpTimeRemaining = 300;
    document.getElementById("timerText").innerHTML =
        'Resend code in <span id="timer">05:00</span>';

    updateTimer();

    fetch("/vendor/auth/forgot-password/resend-otp", { method: "POST" })
        .then(res => res.json())
        .then(data => {
            if (!data.success) {
                alert(data.error || "Failed to resend OTP");
            }
            inputs.forEach(i => i.value = "");
            inputs[0].focus();
        })
        .catch(() => alert("Error sending OTP"));
}

/* ================= AUTO-HIDE ERROR ================= */
const errorBox = document.getElementById("errorBox");

if (errorBox) {
        errorBox.style.transition = "opacity 0.5s ease";

        setTimeout(() => {
            errorBox.style.opacity = "0";
        }, 1500);

        setTimeout(() => {
            errorBox.remove();
        }, 2000);
    }
</script>

</body>
</html>
