<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Verify OTP</title>
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        body {
            background: linear-gradient(135deg, #001a33 0%, #003366 100%);
            min-height: 100vh;
        }

        .otp-input {
            width: 50px;
            height: 50px;
            text-align: center;
            font-size: 24px;
            font-weight: bold;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            background: white;
            color: #001a33;
            transition: all 0.3s ease;
        }

        .otp-input:focus {
            outline: none;
            border-color: #2563eb;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .resend-link {
            color: #3b82f6;
            text-decoration: none;
            font-weight: 500;
            cursor: pointer;
            transition: color 0.3s ease;
            background: none;
            border: none;
            padding: 0;
            font-size: 0.875rem;
        }

        .resend-link:hover:not(.disabled) {
            color: #2563eb;
            text-decoration: underline;
        }

        .resend-link.disabled {
            color: #9ca3af;
            cursor: not-allowed;
        }
    </style>
</head>

<body>
<div class="flex items-center justify-center min-h-screen px-4">
    <div class="w-full max-w-md">

        <form id="otpForm" action="/vendor/auth/verify-otp" method="POST" class="space-y-8">

            <!-- Header -->
            <div class="text-center">
                <h1 class="text-3xl font-bold text-white mb-4">Verify OTP</h1>
                <p class="text-gray-400 text-sm">
                    We've sent a verification code to<br>
                    <span class="text-white font-semibold"><%= email %></span>
                </p>
            </div>

            <!-- OTP Inputs -->
            <div class="flex justify-center gap-3">
                <% for (let i = 0; i < 4; i++) { %>
                    <input 
                        type="text"
                        class="otp-input"
                        maxlength="1"
                        inputmode="numeric"
                        autocomplete="off"
                        required
                    >
                <% } %>
            </div>

            <!-- Hidden OTP -->
            <input type="hidden" name="otp" id="otp">

            <!-- Error -->
            <% if (error) { %>
                <div 
                    id="errorBox"
                    class="bg-red-500 bg-opacity-10 border border-red-500 text-red-200 px-4 py-3 rounded-lg text-sm text-center">
                    <%= error %>
                </div>
            <% } %>

            <!-- Timer -->
            <div class="text-center">
                <p id="timerText" class="text-gray-300 text-sm">
                    Resend code in <span id="timer" class="font-mono">02:00</span>
                </p>
            </div>

            <!-- Resend -->
            <div class="text-center">
                <button 
                    type="button"
                    id="resendBtn"
                    class="resend-link disabled"
                    onclick="resendCode()"
                    disabled>
                    Resend OTP
                </button>
            </div>

            <!-- Submit -->
            <button 
                type="submit"
                class="w-full bg-white text-slate-900 font-semibold py-3 rounded-lg hover:bg-gray-100 transition">
                Verify
            </button>
        </form>

        <div class="text-center mt-6">
            <a href="/auth/login" class="text-blue-400 hover:text-blue-300 text-sm">
                Back to Login
            </a>
        </div>
    </div>
</div>

<script>
    // OTP handling
    const inputs = document.querySelectorAll(".otp-input");
    const hiddenOtpField = document.getElementById("otp");

    inputs.forEach((input, index) => {
        input.addEventListener("input", e => {
            if (!/^[0-9]$/.test(e.target.value)) {
                input.value = "";
                return;
            }
            if (index < inputs.length - 1) inputs[index + 1].focus();
        });

        input.addEventListener("keydown", e => {
            if (e.key === "Backspace" && input.value === "" && index > 0) {
                inputs[index - 1].focus();
            }
        });
    });

    document.getElementById("otpForm").addEventListener("submit", e => {
        const otp = Array.from(inputs).map(i => i.value).join("");
        if (otp.length !== 4) {
            e.preventDefault();
            alert("Please enter a valid 4-digit OTP");
            return;
        }
        hiddenOtpField.value = otp;
    });

    // Timer
    let timeRemaining = 120;
    const timerEl = document.getElementById("timer");
    const resendBtn = document.getElementById("resendBtn");

    function updateTimer() {
        const m = Math.floor(timeRemaining / 60);
        const s = timeRemaining % 60;
        timerEl.textContent = `${String(m).padStart(2,"0")}:${String(s).padStart(2,"0")}`;

        if (timeRemaining > 0) {
            timeRemaining--;
            setTimeout(updateTimer, 1000);
        } else {
            resendBtn.disabled = false;
            resendBtn.classList.remove("disabled");
            document.getElementById("timerText").textContent = "Code expired. Resend now";
        }
    }
    updateTimer();

    function resendCode() {
        if (resendBtn.disabled) return;
        resendBtn.disabled = true;
        resendBtn.classList.add("disabled");

        fetch("/vendor/auth/resend-otp", { method: "POST" })
            .then(() => {
                timeRemaining = 120;
                document.getElementById("timerText").innerHTML =
                    'Resend code in <span id="timer" class="font-mono">02:00</span>';
                updateTimer();
                inputs.forEach(i => i.value = "");
                inputs[0].focus();
            });
    }

    // âœ… Auto-hide error in EXACTLY 3 seconds
    const errorBox = document.getElementById("errorBox");
    if (errorBox) {
        errorBox.style.transition = "opacity 0.5s ease";

        setTimeout(() => {
            errorBox.style.opacity = "0";
        }, 1500);

        setTimeout(() => {
            errorBox.remove();
        }, 2000);
    }
</script>

</body>
</html>
